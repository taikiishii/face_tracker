# 長時間稼働時の問題対策まとめ

## 実装した改善策

### 1. 詳細なロギング機能
- すべてのイベントをログファイルに記録（`face_tracker.log`）
- ログレベルを調整可能（DEBUG, INFO, WARNING, ERROR, CRITICAL）
- ログローテーション機能（10MBごとに最大5世代保存）
- タイムスタンプ付きで問題発生時刻を特定可能

### 2. リソース監視機能
- 5分ごとにシステムリソースを自動チェック
  - メモリ使用量（プロセス＆システム全体）
  - CPU使用率
  - ファイルディスクリプタ数
  - 総フレーム数とエラー回数
- 異常値を検出したら警告ログを出力
- メモリリーク、リソース枯渇を早期発見

### 3. エラーハンドリングの強化
- カメラ読み込みエラーの自動リカバリー
  - 連続エラーが10回を超えたら自動的にカメラを再初期化
  - 再初期化の試行回数を記録
- すべての例外をキャッチしてログに記録
- プロセスのクラッシュを防ぐ

### 4. 監視スクリプト（monitor.sh）
- プログラムの状態を5分ごとに監視
- 以下の異常を検出:
  - プロセス停止
  - メモリ使用量が600MB超過
  - プロセスがゾンビ状態
  - ログファイルが10分以上更新されない
- 異常検出時に自動的にプロセスを再起動

### 5. 診断スクリプト（diagnose.sh）
- システム状態を包括的に診断
- 以下の情報を収集:
  - システムリソース（メモリ、CPU、ディスク）
  - カメラデバイス状態
  - シリアルポート接続
  - プロセス情報
  - カーネルメッセージとエラーログ
  - ファイルディスクリプタ使用状況
- 診断結果をタイムスタンプ付きファイルに保存

## 使用方法

### 基本的な起動
```bash
# ログ記録付きで起動（デフォルト: INFO レベル）
python3 face_tracker.py --no-display

# 詳細ログ（デバッグ用）
python3 face_tracker.py --no-display --log-level DEBUG

# 警告以上のみ記録（通常運用時）
python3 face_tracker.py --no-display --log-level WARNING
```

### 監視スクリプトの使用（推奨）
```bash
# 監視スクリプトをバックグラウンドで起動
nohup ./monitor.sh > /dev/null 2>&1 &

# 監視ログを確認
tail -f monitor.log
```

### 問題が発生した時の対処

1. **診断スクリプトを実行**
```bash
./diagnose.sh
# 生成された diagnosis_*.log ファイルを確認
```

2. **ログファイルを確認**
```bash
# エラーを検索
grep -i error face_tracker.log

# リソース状況を確認
grep "リソース監視" face_tracker.log | tail -20

# カメラ問題を確認
grep -i camera face_tracker.log
```

3. **リアルタイム監視**
```bash
# ログをリアルタイムで監視
tail -f face_tracker.log

# システムリソースを監視
top -p $(pgrep -f face_tracker.py)
```

## 原因の特定方法

### メモリリークの確認
ログファイルでメモリ使用量の推移を確認:
```bash
grep "リソース監視" face_tracker.log | grep -o "メモリ: [0-9.]*MB"
```

時間とともにメモリ使用量が増加していれば、メモリリークの可能性があります。

### カメラエラーの確認
```bash
grep -E "(カメラ|camera)" face_tracker.log | tail -50
```

頻繁な再初期化が発生していれば、カメラデバイスやドライバの問題です。

### サーボエラーの確認
```bash
grep -E "(サーボ|servo)" face_tracker.log | grep -i error
```

## システムサービスとして登録（推奨）

自動起動と監視を確実にするため、systemdサービスとして登録できます。

詳細は `TROUBLESHOOTING.md` を参照してください。

## 次のステップ

1. プログラムを起動してログを収集
2. 24時間以上稼働させる
3. 問題発生時は diagnose.sh を実行
4. ログを分析して原因を特定
5. 必要に応じてさらなる改善を実施

## 技術的な改善点

- `psutil` ライブラリによる正確なリソース監視
- ロギングモジュールによる構造化されたログ出力
- 例外の完全なトレースバック記録
- カメラデバイスの自動復旧機能
- PID管理による適切なプロセス制御
